<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°è±†è…å¾Œå°ï½œç‡Ÿé‹ä¸­æ¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Quill ç·¨è¼¯å™¨æ¨£å¼ -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcYPHZJcSTBRbhKy018keO7FiPyzb4c84",
      authDomain: "tax-tofu.firebaseapp.com",
      projectId: "tax-tofu",
      storageBucket: "tax-tofu.firebasestorage.app",
      messagingSenderId: "1031361168988",
      appId: "1:1031361168988:web:ce06888cfd84de93958899",
      measurementId: "G-TQ29X7NGZY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "tax-tofu";

    // å…¨åŸŸè®Šæ•¸å­˜å„²æ•¸æ“š
    let allCategories = {};
    let allArticles = [];
    let allTools = [];

    // åˆå§‹åŒ– Quill
    window.quill = new Quill('#editor-container', {
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image', 'clean']
        ]
      },
      placeholder: 'åœ¨é€™è£¡è¼¸å…¥ç™½è©±ç¨…å‹™å…§å®¹...',
      theme: 'snow'
    });

    signInAnonymously(auth).catch(err => console.error("èªè­‰å¤±æ•—", err));

    onAuthStateChanged(auth, (user) => {
      const statusEl = document.getElementById('auth-status');
      if (user) {
        statusEl.innerText = "ğŸŸ¢ é›²ç«¯é€£ç·šæ­£å¸¸";
        statusEl.className = "text-xs mt-1 text-green-600 font-medium";
      }
    });

    // 1. ç›£è½åˆ†é¡åˆ—è¡¨
    const catsCol = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
    onSnapshot(query(catsCol, orderBy('weight', 'desc')), (snapshot) => {
      const list = document.getElementById('manage-categories-list');
      const selectArt = document.getElementById('main-category');
      const selectTool = document.getElementById('tool-category');
      const filterArtSelect = document.getElementById('filter-category');
      const filterToolSelect = document.getElementById('filter-tool-category');
      
      list.innerHTML = "";
      const currentArtVal = selectArt.value;
      const currentToolVal = selectTool.value;
      const currentArtFilter = filterArtSelect.value;
      const currentToolFilter = filterToolSelect.value;
      
      const categoryOptions = '<option value="">-- é¸æ“‡åˆ†é¡ --</option>';
      const filterOptions = '<option value="all">æ‰€æœ‰åˆ†é¡</option>';
      
      selectArt.innerHTML = categoryOptions;
      selectTool.innerHTML = categoryOptions;
      filterArtSelect.innerHTML = filterOptions;
      filterToolSelect.innerHTML = filterOptions;
      
      allCategories = {}; 

      snapshot.forEach(record => {
        const item = record.data();
        const id = record.id;
        allCategories[id] = item.name;
        
        list.innerHTML += `
          <div class="border-b py-3 flex justify-between items-center group">
            <div class="truncate pr-4">
              <span class="inline-block w-8 h-8 bg-amber-100 text-amber-700 text-center leading-8 rounded-lg text-xs font-bold mr-2">${item.weight || 0}</span>
              <span class="font-bold text-stone-700">${item.name}</span>
            </div>
            <div class="flex gap-3 shrink-0">
              <button onclick="editCategory('${id}', '${item.name}', ${item.weight || 0})" class="text-amber-600 text-sm hover:underline">ä¿®æ”¹</button>
              <button onclick="deleteItem('categories', '${id}')" class="text-red-400 text-sm hover:text-red-600">åˆªé™¤</button>
            </div>
          </div>
        `;

        const opt = `<option value="${id}">${item.name}</option>`;
        selectArt.innerHTML += opt;
        selectTool.innerHTML += opt;
        filterArtSelect.innerHTML += opt;
        filterToolSelect.innerHTML += opt;
      });

      selectArt.value = currentArtVal;
      selectTool.value = currentToolVal;
      filterArtSelect.value = currentArtFilter;
      filterToolSelect.value = currentToolFilter;
      
      renderArticleList();
      renderToolList();
    });

    // 2. ç›£è½æ–‡ç« åˆ—è¡¨
    const articlesCol = collection(db, 'artifacts', appId, 'public', 'data', 'articles');
    onSnapshot(query(articlesCol, orderBy('createdAt', 'desc')), (snapshot) => {
      allArticles = [];
      snapshot.forEach(record => {
        allArticles.push({ id: record.id, ...record.data() });
      });
      renderArticleList();
    });

    // 3. ç›£è½å·¥å…·åˆ—è¡¨
    const toolsCol = collection(db, 'artifacts', appId, 'public', 'data', 'tools');
    onSnapshot(query(toolsCol, orderBy('createdAt', 'desc')), (snapshot) => {
      allTools = [];
      snapshot.forEach(record => {
        allTools.push({ id: record.id, ...record.data() });
      });
      renderToolList();
    });

    // æ¸²æŸ“æ–‡ç« åˆ—è¡¨é‚è¼¯
    window.renderArticleList = function() {
      const list = document.getElementById('manage-articles-list');
      const filterCat = document.getElementById('filter-category').value;
      const sortType = document.getElementById('sort-articles').value;

      let filtered = [...allArticles];
      if (filterCat !== 'all') filtered = filtered.filter(a => a.categoryId === filterCat);

      filtered.sort((a, b) => {
        if (sortType === 'newest') return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        if (sortType === 'title') return a.title.localeCompare(b.title, 'zh-Hant');
        if (sortType === 'category') {
          const nameA = allCategories[a.categoryId] || "";
          const nameB = allCategories[b.categoryId] || "";
          return nameA.localeCompare(nameB, 'zh-Hant');
        }
        return 0;
      });

      list.innerHTML = filtered.length ? "" : '<p class="text-center py-10 text-stone-400 text-sm">æš«ç„¡åŒ¹é…çš„æ–‡ç« </p>';
      filtered.forEach(item => {
        const catName = allCategories[item.categoryId] || "æœªåˆ†é¡";
        list.innerHTML += `
          <div class="border-b py-4 flex justify-between items-center group">
            <div class="truncate pr-4">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 bg-stone-100 text-stone-500 text-[10px] rounded font-bold">${catName}</span>
                <p class="font-bold text-stone-700 truncate">${item.title}</p>
              </div>
              <p class="text-xs text-stone-400 italic">ç™¼ä½ˆæ–¼ ${item.createdAt?.toDate().toLocaleDateString() || 'å‰›æ‰'}</p>
            </div>
            <div class="flex gap-3 shrink-0">
              <button onclick="editItem('articles', '${item.id}', '${btoa(encodeURIComponent(JSON.stringify(item)))}')" class="text-amber-600 text-sm font-bold hover:underline">ä¿®æ”¹</button>
              <button onclick="deleteItem('articles', '${item.id}')" class="text-red-300 text-sm hover:text-red-600 transition">åˆªé™¤</button>
            </div>
          </div>
        `;
      });
    };

    // æ¸²æŸ“å·¥å…·åˆ—è¡¨é‚è¼¯ (æ–°å¢åˆ†é¡é¡¯ç¤ºèˆ‡æ’åº)
    window.renderToolList = function() {
      const list = document.getElementById('manage-tools-list');
      const filterCat = document.getElementById('filter-tool-category').value;
      const sortType = document.getElementById('sort-tools').value;

      let filtered = [...allTools];
      if (filterCat !== 'all') filtered = filtered.filter(t => t.categoryId === filterCat);

      filtered.sort((a, b) => {
        if (sortType === 'newest') return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        if (sortType === 'name') return a.name.localeCompare(b.name, 'zh-Hant');
        if (sortType === 'category') {
          const nameA = allCategories[a.categoryId] || "";
          const nameB = allCategories[b.categoryId] || "";
          return nameA.localeCompare(nameB, 'zh-Hant');
        }
        return 0;
      });

      list.innerHTML = filtered.length ? "" : '<p class="text-center py-10 text-stone-400 text-sm">æš«ç„¡åŒ¹é…çš„å·¥å…·</p>';
      filtered.forEach(item => {
        const catName = allCategories[item.categoryId] || "æœªåˆ†é¡";
        list.innerHTML += `
          <div class="border-b py-4 flex justify-between items-center group">
            <div class="truncate pr-4">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 bg-amber-50 text-amber-600 text-[10px] rounded font-bold">${catName}</span>
                <p class="font-bold text-stone-700 truncate">${item.name}</p>
              </div>
              <p class="text-xs text-stone-400 truncate">${item.link}</p>
            </div>
            <div class="flex gap-3 shrink-0">
              <button onclick="editItem('tools', '${item.id}', '${btoa(encodeURIComponent(JSON.stringify(item)))}')" class="text-amber-600 text-sm font-bold hover:underline">ä¿®æ”¹</button>
              <button onclick="deleteItem('tools', '${item.id}')" class="text-red-300 text-sm hover:text-red-600 transition">åˆªé™¤</button>
            </div>
          </div>
        `;
      });
    };

    window.db = db;
    window.appId = appId;
    window.addDoc = addDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.collection = collection;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    :root {
      --primary-yellow: #FFF2CC;
      --accent-brown: #8D7B68;
    }
    body { background: #fdfaf5; color: #54473F; font-family: sans-serif; transition: 0.3s; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
    .btn-primary { background: var(--accent-brown); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; transition: 0.3s; }
    .btn-ai { background: #fdf2f8; color: #db2777; border: 1px solid #fbcfe8; padding: 10px 16px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
    
    .nav-tab { padding: 12px 20px; border-radius: 12px 12px 0 0; cursor: pointer; font-weight: bold; opacity: 0.6; transition: 0.2s; }
    .nav-tab.active { background: white; opacity: 1; color: var(--accent-brown); box-shadow: 0 -5px 10px rgba(0,0,0,0.02); }

    #editor-container { height: 350px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
    .ql-toolbar.ql-snow { border-top-left-radius: 12px; border-top-right-radius: 12px; background: #fcfcfc; }

    .section-content { display: none; opacity: 0; }
    .section-content.active { display: grid; opacity: 1; }

    #ai-drawer {
      position: fixed; top: 0; right: -400px; width: 380px; height: 100%;
      background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
      z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column;
    }
    #ai-drawer.open { right: 0; }

    #lock-screen {
      position: fixed; inset: 0; background: var(--primary-yellow);
      z-index: 10000; display: flex; align-items: center; justify-content: center;
    }
    .lock-box { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; max-width: 320px; width: 90%; }
  </style>
</head>
<body class="p-4 md:p-10">

  <!-- å¯†ç¢¼é– -->
  <div id="lock-screen">
    <div class="lock-box">
      <div class="w-16 h-16 bg-amber-100 rounded-2xl mx-auto mb-6 flex items-center justify-center text-3xl">ğŸ—„ï¸</div>
      <h2 class="text-xl font-bold mb-2 text-stone-800">ç‡Ÿé‹ä¸­æ¨å®‰å…¨æª¢æŸ¥</h2>
      <p class="text-sm text-stone-400 mb-6">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
      <input type="password" id="admin-password" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full p-3 border rounded-xl text-center mb-4 tracking-widest outline-none focus:ring-2 focus:ring-amber-200">
      <button onclick="checkPassword()" class="btn-primary w-full">é€²å…¥å¾Œå°</button>
      <p id="error-msg" class="text-red-400 text-xs mt-3 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>
    </div>
  </div>

  <!-- AI å´é‚Šæ¬„æŠ½å±œ -->
  <div id="ai-drawer">
    <div class="p-6 border-b flex justify-between items-center bg-pink-50">
      <h3 class="font-black text-pink-600">âœ¨ AI å…§å®¹å°å¹«æ‰‹</h3>
      <button onclick="toggleAIDrawer()" class="text-stone-400 hover:text-stone-700">âœ•</button>
    </div>
    <div class="flex-1 overflow-y-auto p-6 space-y-6">
      <div id="ai-result" class="text-sm leading-relaxed text-stone-700 whitespace-pre-wrap">è«‹å…ˆè¼¸å…¥æ–‡ç« å…§å®¹ï¼Œå†é»æ“Šä¸‹æ–¹ AI åŠŸèƒ½ã€‚</div>
    </div>
    <div class="p-4 border-t grid grid-cols-2 gap-2">
      <button onclick="callAIFeature('polish')" class="text-xs bg-stone-800 text-white py-2 rounded-lg hover:bg-black transition">âœ¨ å¤§ç™½è©±æ½¤é£¾</button>
      <button onclick="callAIFeature('summarize')" class="text-xs bg-stone-800 text-white py-2 rounded-lg hover:bg-black transition">âœ¨ ç¸®æ¸›æˆç²¾è¯</button>
      <button onclick="callAIFeature('image-idea')" class="text-xs bg-stone-800 text-white py-2 rounded-lg hover:bg-black transition">ğŸ–¼ï¸ é…åœ–å»ºè­°</button>
      <button onclick="copyAIResult()" class="text-xs bg-pink-100 text-pink-600 py-2 rounded-lg font-bold">ğŸ“‹ è¤‡è£½çµæœ</button>
    </div>
  </div>

  <div id="main-content-wrapper" class="hidden">
    <header class="max-w-6xl mx-auto mb-6 flex justify-between items-end">
      <div>
        <h1 class="text-3xl font-black text-stone-700 tracking-tight">å°è±†è…ç‡Ÿé‹ä¸­æ¨ ğŸ› ï¸</h1>
        <p id="auth-status" class="text-xs mt-1 text-amber-500 font-medium">ğŸŸ¡ æ­£åœ¨é€£ç·šä¸­...</p>
      </div>
      <div class="flex gap-4 items-center">
        <button onclick="toggleAIDrawer()" class="btn-ai text-sm">âœ¨ AI å°å¹«æ‰‹</button>
        <button onclick="logout()" class="text-sm text-stone-400 hover:text-red-400 font-medium">ç™»å‡º</button>
      </div>
    </header>

    <div class="max-w-6xl mx-auto flex gap-1">
      <div onclick="switchSection('write')" id="tab-write" class="nav-tab active">å…§å®¹å‰µä½œ</div>
      <div onclick="switchSection('category')" id="tab-category" class="nav-tab">åˆ†é¡ç®¡ç†</div>
      <div onclick="switchSection('tools-manage')" id="tab-tools-manage" class="nav-tab">å·¥å…·ç¶­è­·</div>
    </div>

    <main class="max-w-6xl mx-auto">
      
      <!-- å…§å®¹å‰µä½œ -->
      <div id="section-write" class="section-content active grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-7">
          <section class="card">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-stone-800">âœï¸ <span id="form-title">æ’°å¯«éƒ¨è½æ ¼æ–‡ç« </span></h2>
            <div class="space-y-6">
              <input type="hidden" id="edit-id">
              <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-bold mb-1 text-stone-500">æ–‡ç« æ¨™é¡Œ</label>
                  <input type="text" id="main-title" placeholder="æ¨™é¡Œ" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
                </div>
                <div class="col-span-2 md:col-span-1">
                  <label class="block text-sm font-bold mb-1 text-stone-500">æ‰€å±¬åˆ†é¡</label>
                  <select id="main-category" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200 bg-white">
                    <option value="">-- é¸æ“‡åˆ†é¡ --</option>
                  </select>
                </div>
              </div>
              <div id="editor-container"></div>
              <button onclick="saveData()" id="save-btn" class="btn-primary w-full py-4 text-lg">ç¢ºèªå„²å­˜ä¸¦ç™¼ä½ˆ</button>
            </div>
          </section>
        </div>
        <div class="lg:col-span-5">
          <section class="card h-full flex flex-col">
            <h2 class="text-lg font-bold mb-4 border-b pb-2 text-stone-700">ğŸ“˜ æ–‡ç« åˆ—è¡¨</h2>
            <div class="grid grid-cols-2 gap-2 mb-4">
              <select id="filter-category" onchange="renderArticleList()" class="text-xs p-2 border rounded-lg bg-stone-50 outline-none"></select>
              <select id="sort-articles" onchange="renderArticleList()" class="text-xs p-2 border rounded-lg bg-stone-50 outline-none">
                <option value="newest">æœ€æ–°ç™¼ä½ˆ</option>
                <option value="category">ä¾åˆ†é¡æ’åº</option>
                <option value="title">ä¾æ¨™é¡Œæ’åº</option>
              </select>
            </div>
            <div id="manage-articles-list" class="divide-y divide-stone-100 flex-1 overflow-y-auto pr-2 min-h-[400px]"></div>
          </section>
        </div>
      </div>

      <!-- åˆ†é¡ç®¡ç† -->
      <div id="section-category" class="section-content grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-5">
          <section class="card">
            <h2 class="text-xl font-bold mb-6 text-stone-800">ğŸ·ï¸ åˆ†é¡ç®¡ç†</h2>
            <div class="space-y-4">
              <input type="hidden" id="cat-edit-id">
              <input type="text" id="cat-name" placeholder="åˆ†é¡åç¨±" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
              <input type="number" id="cat-weight" placeholder="æ’åºæ¬Šé‡ (æ•¸å­—å¤§åœ¨å‰)" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
              <div class="flex gap-2">
                <button onclick="saveCategory()" id="cat-save-btn" class="btn-primary flex-1">å„²å­˜åˆ†é¡</button>
                <button onclick="resetCategoryForm()" class="bg-stone-100 px-4 rounded-xl text-stone-500">å–æ¶ˆ</button>
              </div>
            </div>
          </section>
        </div>
        <div class="lg:col-span-7">
          <section class="card">
            <h2 class="text-lg font-bold mb-4 border-b pb-2 text-stone-700">ç›®å‰çš„åˆ†é¡ (ä¾æ¬Šé‡)</h2>
            <div id="manage-categories-list" class="divide-y"></div>
          </section>
        </div>
      </div>

      <!-- å·¥å…·ç¶­è­· (æ–°å¢åˆ†é¡æ’åºåŠŸèƒ½) -->
      <div id="section-tools-manage" class="section-content grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-5">
          <section class="card">
            <h2 class="text-xl font-bold mb-6 text-stone-800">ğŸ§® å·¥å…·èˆ‡é€£çµç¶­è­·</h2>
            <div class="space-y-4">
              <input type="hidden" id="tool-edit-id">
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1 text-stone-500">å·¥å…·åç¨±</label>
                  <input type="text" id="tool-name" placeholder="å¦‚ï¼šç¶œåˆæ‰€å¾—ç¨…è©¦ç®—" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1 text-stone-500">æ‰€å±¬åˆ†é¡</label>
                  <select id="tool-category" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200 bg-white"></select>
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1 text-stone-500">ç¶²å€</label>
                  <input type="text" id="tool-link" placeholder="https://..." class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1 text-stone-500">ç°¡çŸ­æè¿°</label>
                  <textarea id="tool-desc" placeholder="ç°¡å–®èªªæ˜é€™å€‹å·¥å…·çš„ç”¨é€”" class="w-full p-3 border rounded-xl h-24 outline-none focus:ring-2 focus:ring-amber-200"></textarea>
                </div>
              </div>
              <button onclick="saveTool()" id="tool-save-btn" class="btn-primary w-full">ç¢ºèªç™¼ä½ˆå·¥å…·</button>
            </div>
          </section>
        </div>
        <div class="lg:col-span-7">
          <section class="card h-full flex flex-col">
            <h2 class="text-lg font-bold mb-4 border-b pb-2 text-stone-700">ğŸ› ï¸ ç¾æœ‰å·¥å…·åˆ—è¡¨</h2>
            <div class="grid grid-cols-2 gap-2 mb-4">
              <select id="filter-tool-category" onchange="renderToolList()" class="text-xs p-2 border rounded-lg bg-stone-50 outline-none"></select>
              <select id="sort-tools" onchange="renderToolList()" class="text-xs p-2 border rounded-lg bg-stone-50 outline-none">
                <option value="newest">æœ€æ–°æ–°å¢</option>
                <option value="category">ä¾åˆ†é¡æ’åº</option>
                <option value="name">ä¾åç¨±æ’åº</option>
              </select>
            </div>
            <div id="manage-tools-list" class="divide-y divide-stone-100 flex-1 overflow-y-auto pr-2 min-h-[400px]"></div>
          </section>
        </div>
      </div>

    </main>
  </div>

  <script>
    const correctPassword = "8888"; 
    const apiKey = ""; 

    function switchSection(id) {
      ['write', 'category', 'tools-manage'].forEach(s => {
        document.getElementById(`section-${s}`).classList.remove('active');
        document.getElementById(`tab-${s}`).classList.remove('active');
      });
      document.getElementById(`section-${id}`).classList.add('active');
      document.getElementById(`tab-${id}`).classList.add('active');
    }

    // åˆ†é¡æ“ä½œ
    async function saveCategory() {
      const name = document.getElementById('cat-name').value;
      const weight = parseInt(document.getElementById('cat-weight').value) || 0;
      const id = document.getElementById('cat-edit-id').value;
      if(!name) return alert("è«‹å¡«å¯«åˆ†é¡åç¨±");
      try {
        if(id) await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'categories', id), { name, weight });
        else await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'categories'), { name, weight, createdAt: window.serverTimestamp() });
        resetCategoryForm();
      } catch (e) { alert("æ“ä½œå¤±æ•—"); }
    }

    function editCategory(id, name, weight) {
      document.getElementById('cat-edit-id').value = id;
      document.getElementById('cat-name').value = name;
      document.getElementById('cat-weight').value = weight;
      document.getElementById('cat-save-btn').innerText = "æ›´æ–°åˆ†é¡";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetCategoryForm() {
      document.getElementById('cat-edit-id').value = "";
      document.getElementById('cat-name').value = "";
      document.getElementById('cat-weight').value = 0;
      document.getElementById('cat-save-btn').innerText = "å„²å­˜åˆ†é¡";
    }

    // å·¥å…·æ“ä½œ
    async function saveTool() {
      const id = document.getElementById('tool-edit-id').value;
      const name = document.getElementById('tool-name').value;
      const categoryId = document.getElementById('tool-category').value;
      const link = document.getElementById('tool-link').value;
      const description = document.getElementById('tool-desc').value;
      if(!name || !link || !categoryId) return alert("è«‹å¡«å¯«å®Œæ•´å…§å®¹ï¼ˆå«åˆ†é¡ï¼‰");
      
      const btn = document.getElementById('tool-save-btn');
      btn.disabled = true;
      try {
        if(id) await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'tools', id), { name, categoryId, link, description });
        else await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'tools'), { name, categoryId, link, description, createdAt: window.serverTimestamp() });
        alert("å·¥å…·å·²å„²å­˜ï¼");
        resetToolForm();
      } catch (e) { alert("éŒ¯èª¤"); } finally { btn.disabled = false; }
    }

    function resetToolForm() {
      document.getElementById('tool-edit-id').value = "";
      document.getElementById('tool-name').value = "";
      document.getElementById('tool-category').value = "";
      document.getElementById('tool-link').value = "";
      document.getElementById('tool-desc').value = "";
      document.getElementById('tool-save-btn').innerText = "ç¢ºèªç™¼ä½ˆå·¥å…·";
    }

    // æ–‡ç« ä¿å­˜
    async function saveData() {
      const id = document.getElementById('edit-id').value;
      const title = document.getElementById('main-title').value;
      const categoryId = document.getElementById('main-category').value;
      const content = window.quill.root.innerHTML;
      if(!title || !categoryId || window.quill.getText().trim() === "") return alert("è«‹å¡«å¯«å®Œæ•´å…§å®¹");

      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      try {
        if(id) await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'articles', id), { title, categoryId, content });
        else await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'articles'), { title, categoryId, content, createdAt: window.serverTimestamp() });
        alert("æ–‡ç« å·²å„²å­˜ï¼");
        resetForm();
      } catch (e) { alert("å„²å­˜å¤±æ•—"); } finally { btn.disabled = false; }
    }

    window.editItem = function(type, id, encodedData) {
      const data = JSON.parse(decodeURIComponent(atob(encodedData)));
      if(type === 'articles') {
        document.getElementById('edit-id').value = id;
        document.getElementById('main-title').value = data.title;
        document.getElementById('main-category').value = data.categoryId || "";
        window.quill.root.innerHTML = data.content;
        document.getElementById('form-title').innerText = "ä¿®æ”¹æ–‡ç« å…§å®¹";
        switchSection('write');
      } else if (type === 'tools') {
        document.getElementById('tool-edit-id').value = id;
        document.getElementById('tool-name').value = data.name;
        document.getElementById('tool-category').value = data.categoryId || "";
        document.getElementById('tool-link').value = data.link;
        document.getElementById('tool-desc').value = data.description || "";
        document.getElementById('tool-save-btn').innerText = "æ›´æ–°å·¥å…·è³‡è¨Š";
        switchSection('tools-manage');
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.deleteItem = async function(type, id) {
      if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
      await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', type, id));
    }

    function resetForm() {
      document.getElementById('edit-id').value = "";
      document.getElementById('main-title').value = "";
      document.getElementById('main-category').value = "";
      window.quill.setContents([]);
      document.getElementById('form-title').innerText = "æ’°å¯«éƒ¨è½æ ¼æ–‡ç« ";
    }

    // AI & å…¶ä»– (å¯†ç¢¼é–ã€ç™»å‡ºç­‰)
    function toggleAIDrawer() { document.getElementById('ai-drawer').classList.toggle('open'); }
    function checkPassword() {
      if (document.getElementById('admin-password').value === correctPassword) unlock(); 
      else document.getElementById('error-msg').classList.remove('hidden');
    }
    function unlock() {
      document.getElementById('lock-screen').style.display = "none";
      document.getElementById('main-content-wrapper').classList.replace('hidden', 'block');
      sessionStorage.setItem('isLoggedIn', 'true');
    }
    function logout() { sessionStorage.removeItem('isLoggedIn'); window.location.reload(); }
    window.onload = () => { if (sessionStorage.getItem('isLoggedIn') === 'true') unlock(); };
    document.getElementById('admin-password')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });
  </script>
</body>
</html>
