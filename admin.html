<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°è±†è…å¾Œå°ï½œç‡Ÿé‹ä¸­æ¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK å°å…¥ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcYPHZJcSTBRbhKy018keO7FiPyzb4c84",
      authDomain: "tax-tofu.firebaseapp.com",
      projectId: "tax-tofu",
      storageBucket: "tax-tofu.firebasestorage.app",
      messagingSenderId: "1031361168988",
      appId: "1:1031361168988:web:ce06888cfd84de93958899",
      measurementId: "G-TQ29X7NGZY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "tax-tofu";

    // èº«ä»½é©—è­‰é‚è¼¯ï¼šè™•ç†åŒ¿åç™»å…¥
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Auth failed:", error);
        if (error.code === 'auth/configuration-not-found') {
          alert("ã€ç³»çµ±æé†’ã€‘è«‹è‡³ Firebase æ§åˆ¶å°é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€åŠŸèƒ½ï¼Œå¦å‰‡ç„¡æ³•ç™¼ä½ˆå…§å®¹å”·ï¼");
        }
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("Firebase é€£çµæˆåŠŸï¼Œç”¨æˆ¶ ID:", user.uid);
        document.getElementById('auth-status').innerText = "ğŸŸ¢ é›²ç«¯é€£ç·šæ­£å¸¸";
        document.getElementById('auth-status').classList.replace('text-red-500', 'text-green-500');
      } else {
        document.getElementById('auth-status').innerText = "ğŸ”´ æœªé€£ç·šè‡³é›²ç«¯";
        document.getElementById('auth-status').classList.replace('text-green-500', 'text-red-500');
      }
    });

    initAuth();

    window.db = db;
    window.appId = appId;
    window.addDoc = addDoc;
    window.collection = collection;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    :root {
      --primary-yellow: #FFF2CC;
      --accent-brown: #8D7B68;
    }
    body { background: #fdfaf5; color: #54473F; }
    .btn-primary { background: var(--accent-brown); color: white; padding: 10px 20px; border-radius: 50px; transition: 0.3s; }
    .btn-primary:hover { transform: scale(1.05); opacity: 0.9; }
    .btn-primary:disabled { background: #ccc; transform: none; cursor: not-allowed; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent-brown); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-4 md:p-8">

  <header class="max-w-4xl mx-auto mb-8 flex justify-between items-end">
    <div>
      <h1 class="text-3xl font-bold text-stone-700">å°è±†è…ç®¡ç†ä¸­æ¨ ğŸ› ï¸</h1>
      <p id="auth-status" class="text-xs mt-1 text-red-500 font-medium">ğŸŸ¡ æ­£åœ¨æª¢æŸ¥é€£ç·š...</p>
    </div>
    <a href="index.html" class="text-stone-400 hover:text-stone-600 text-sm">è¿”å›å®¢æˆ¶ç«¯</a>
  </header>

  <main class="max-w-4xl mx-auto">
    
    <!-- 1. AI éƒ¨è½æ ¼åŠ©æ‰‹ -->
    <section class="card">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">âœ¨ AI è‡ªå‹•æ’°ç¨¿åŠ©æ‰‹</h2>
      <div class="flex gap-2 mb-4">
        <input type="text" id="ai-topic" placeholder="è¼¸å…¥ç¨…å‹™é—œéµå­—ï¼ˆå¦‚ï¼šå‰µæ¥­è²¸æ¬¾ã€ç‡Ÿæ¥­ç¨…æ–°åˆ¶ï¼‰" class="flex-1 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-amber-200">
        <button onclick="generateArticle()" id="gen-btn" class="btn-primary">é–‹å§‹ç”Ÿæˆ</button>
      </div>
      <div id="ai-status" class="hidden text-sm text-amber-600 mb-2 items-center gap-2">
        <div class="loading-spinner"></div> è±†è…æ­£åœ¨ç¿»æ‰¾æœ€æ–°æ³•è¦...
      </div>
      <textarea id="ai-result" rows="8" class="w-full p-4 border rounded-xl bg-gray-50 text-sm mb-4" placeholder="AI ç”Ÿæˆçš„å…§å®¹å°‡å‡ºç¾åœ¨é€™è£¡..."></textarea>
      <div class="flex justify-end">
        <button onclick="publishArticle()" id="pub-btn" class="text-sm bg-stone-100 border border-stone-300 px-4 py-2 rounded-full hover:bg-stone-200 transition">ç¢ºèªç™¼ä½ˆæ–‡ç« </button>
      </div>
    </section>

    <!-- 2. ç¨…å‹™å°å·¥å…·ç®¡ç† -->
    <section class="card">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ§® å·¥å…·èˆ‡æ•™å­¸ç®¡ç†</h2>
      <div class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="tool-name" placeholder="å·¥å…·åç¨± (å¦‚ï¼šç™¼ç¥¨è©¦ç®—)" class="p-3 border rounded-xl">
          <input type="text" id="tool-link" placeholder="å·¥å…·é€£çµ (URL)" class="p-3 border rounded-xl">
        </div>
        <textarea id="tool-desc" rows="3" class="w-full p-3 border rounded-xl" placeholder="å¯«ä¸€é»çµ¦å®¢æˆ¶çš„ã€Œè±†è…å®åš€ã€..."></textarea>
        <button onclick="addTool()" id="tool-btn" class="w-full py-3 bg-amber-100 text-amber-800 font-bold rounded-xl hover:bg-amber-200 transition">å°‡å·¥å…·ä¸Šæ¶è‡³é¦–é </button>
      </div>
    </section>

  </main>

  <script>
    const apiKey = ""; // åŸ·è¡Œç’°å¢ƒè‡ªå‹•å¡«å…¥

    async function generateArticle() {
      const topic = document.getElementById('ai-topic').value;
      if(!topic) return alert("è«‹è¼¸å…¥æƒ³è¦è¨è«–çš„ç¨…å‹™ä¸»é¡Œï¼");

      const btn = document.getElementById('gen-btn');
      const status = document.getElementById('ai-status');
      const resultArea = document.getElementById('ai-result');

      btn.disabled = true;
      status.classList.replace('hidden', 'flex');
      resultArea.value = "è±†è…æ­£åœ¨åˆ†ææ³•è¦ä¸¦çµ„ç¹”èªè¨€...";

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `è«‹é‡å°ã€Œ${topic}ã€å¯«ä¸€ç¯‡ç´„ 400 å­—çš„ç™½è©±ç¨…å‹™éƒ¨è½æ ¼ã€‚èªæ°£è¦åƒã€Œç¨…å‹™å°è±†è…ã€ä¸€æ¨£å¯æ„›ä¸”è¦ªåˆ‡ï¼Œå…§å®¹åŒ…å« 1. é‡é»è§£æ 2. å¸¸è¦‹è¿·æ€ 3. è±†è…çš„å°å®åš€ã€‚` }] }],
            tools: [{ "google_search": {} }]
          })
        });

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ç”Ÿæˆçš„å…§å®¹æœ‰èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        resultArea.value = text;
      } catch (error) {
        resultArea.value = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
      } finally {
        btn.disabled = false;
        status.classList.replace('flex', 'hidden');
      }
    }

    async function publishArticle() {
      const content = document.getElementById('ai-result').value;
      const topic = document.getElementById('ai-topic').value || "ç¨…å‹™æ–°çŸ¥";
      if(!content) return alert("è«‹å…ˆç”Ÿæˆæˆ–å¡«å¯«å…§å®¹ï¼");

      const pubBtn = document.getElementById('pub-btn');
      pubBtn.disabled = true;

      try {
        await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'articles'), {
          title: topic,
          content: content,
          createdAt: window.serverTimestamp()
        });
        alert("ğŸ‰ ç™¼ä½ˆæˆåŠŸï¼å®¢æˆ¶ç«¯å·²å¯æŸ¥çœ‹æ–°æ–‡ç« ã€‚");
      } catch (e) {
        alert("ç™¼ä½ˆå¤±æ•—ï¼Œè«‹ç¢ºèª Firebase çš„ã€ŒåŒ¿åç™»å…¥ã€èˆ‡ã€ŒFirestore è¦å‰‡ã€æ˜¯å¦å·²é–‹å•Ÿã€‚");
      } finally {
        pubBtn.disabled = false;
      }
    }

    async function addTool() {
      const name = document.getElementById('tool-name').value;
      const link = document.getElementById('tool-link').value;
      const desc = document.getElementById('tool-desc').value;

      if(!name || !link) return alert("åç¨±èˆ‡é€£çµä¸å¯ç‚ºç©ºï¼");

      const toolBtn = document.getElementById('tool-btn');
      toolBtn.disabled = true;

      try {
        await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'tools'), {
          name: name,
          link: link,
          description: desc,
          createdAt: window.serverTimestamp()
        });
        alert("âœ… å·¥å…·å·²æˆåŠŸä¸Šæ¶ï¼");
        document.getElementById('tool-name').value = "";
        document.getElementById('tool-link').value = "";
        document.getElementById('tool-desc').value = "";
      } catch (e) {
        alert("ä¸Šæ¶å¤±æ•—ã€‚");
      } finally {
        toolBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
