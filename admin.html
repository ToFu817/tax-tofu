<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°è±†è…å¾Œå°ï½œç‡Ÿé‹ä¸­æ¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- åŠ å…¥ Quill ç·¨è¼¯å™¨çš„æ¨£å¼èˆ‡è…³æœ¬ -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Firebase SDK å°å…¥ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcYPHZJcSTBRbhKy018keO7FiPyzb4c84",
      authDomain: "tax-tofu.firebaseapp.com",
      projectId: "tax-tofu",
      storageBucket: "tax-tofu.firebasestorage.app",
      messagingSenderId: "1031361168988",
      appId: "1:1031361168988:web:ce06888cfd84de93958899",
      measurementId: "G-TQ29X7NGZY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "tax-tofu";

    // åˆå§‹åŒ– Quill ç·¨è¼¯å™¨
    window.quill = new Quill('#editor-container', {
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image', 'clean']
        ]
      },
      placeholder: 'åœ¨é€™è£¡è¼¸å…¥ç™½è©±ç¨…å‹™å…§å®¹ï¼Œæ”¯æ´æ’å…¥åœ–ç‰‡èˆ‡æ’ç‰ˆ...',
      theme: 'snow'
    });

    // èº«ä»½é©—è­‰
    signInAnonymously(auth).catch(err => console.error("èªè­‰å¤±æ•—", err));

    onAuthStateChanged(auth, (user) => {
      const statusEl = document.getElementById('auth-status');
      if (user) {
        statusEl.innerText = "ğŸŸ¢ é›²ç«¯é€£ç·šæ­£å¸¸ (å·²æˆæ¬Š)";
        statusEl.className = "text-xs mt-1 text-green-600 font-medium";
      } else {
        statusEl.innerText = "ğŸ”´ æœªé€£ç·š";
        statusEl.className = "text-xs mt-1 text-red-500 font-medium";
      }
    });

    // ç›£è½æ–‡ç« åˆ—è¡¨ (ç”¨æ–¼å³å´ç®¡ç†å€)
    const articlesCol = collection(db, 'artifacts', appId, 'public', 'data', 'articles');
    onSnapshot(query(articlesCol, orderBy('createdAt', 'desc')), (snapshot) => {
      const list = document.getElementById('manage-articles-list');
      list.innerHTML = "";
      snapshot.forEach(record => {
        const item = record.data();
        const id = record.id;
        list.innerHTML += `
          <div class="border-b py-4 flex justify-between items-center group">
            <div class="truncate pr-4">
              <p class="font-bold text-stone-700">${item.title}</p>
              <p class="text-xs text-stone-400">ç™¼ä½ˆæ–¼ ${item.createdAt?.toDate().toLocaleDateString() || 'å‰›æ‰'}</p>
            </div>
            <div class="flex gap-3 shrink-0">
              <button onclick="editItem('articles', '${id}', '${btoa(encodeURIComponent(JSON.stringify(item)))}')" class="text-amber-600 text-sm font-bold hover:underline">ä¿®æ”¹</button>
              <button onclick="deleteItem('articles', '${id}')" class="text-red-400 text-sm hover:text-red-600 transition">åˆªé™¤</button>
            </div>
          </div>
        `;
      });
    });

    // ç›£è½å·¥å…·åˆ—è¡¨ (ç”¨æ–¼å³å´ç®¡ç†å€)
    const toolsCol = collection(db, 'artifacts', appId, 'public', 'data', 'tools');
    onSnapshot(query(toolsCol, orderBy('createdAt', 'desc')), (snapshot) => {
      const list = document.getElementById('manage-tools-list');
      list.innerHTML = "";
      snapshot.forEach(record => {
        const item = record.data();
        const id = record.id;
        list.innerHTML += `
          <div class="border-b py-4 flex justify-between items-center">
            <div class="truncate pr-4">
              <p class="font-bold text-stone-700">${item.name}</p>
              <p class="text-xs text-stone-400">${item.link}</p>
            </div>
            <div class="flex gap-3 shrink-0">
              <button onclick="editItem('tools', '${id}', '${btoa(encodeURIComponent(JSON.stringify(item)))}')" class="text-amber-600 text-sm font-bold hover:underline">ä¿®æ”¹</button>
              <button onclick="deleteItem('tools', '${id}')" class="text-red-400 text-sm hover:text-red-600 transition">åˆªé™¤</button>
            </div>
          </div>
        `;
      });
    });

    // å°‡ Firebase å¯¦ä¾‹å°å‡ºåˆ° window
    window.db = db;
    window.appId = appId;
    window.addDoc = addDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.collection = collection;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    :root {
      --primary-yellow: #FFF2CC;
      --accent-brown: #8D7B68;
    }
    body { background: #fdfaf5; color: #54473F; font-family: sans-serif; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
    .btn-primary { background: var(--accent-brown); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; transition: 0.3s; }
    .btn-primary:hover:not(:disabled) { transform: scale(1.02); opacity: 0.9; }
    .input-field { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; outline: none; transition: 0.2s; }
    .input-field:focus { border-color: var(--accent-brown); }
    
    /* Quill ç·¨è¼¯å™¨æ¨£å¼è‡ªè¨‚ */
    #editor-container {
      height: 400px;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      font-family: inherit;
    }
    .ql-toolbar.ql-snow {
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      background: #fcfcfc;
    }
  </style>
</head>
<body class="p-4 md:p-10">

  <header class="max-w-6xl mx-auto mb-10 flex justify-between items-end">
    <div>
      <h1 class="text-3xl font-black text-stone-700 tracking-tight">å°è±†è…ç‡Ÿé‹ä¸­æ¨ ğŸ› ï¸</h1>
      <p id="auth-status" class="text-xs mt-1 text-amber-500 font-medium">ğŸŸ¡ æ­£åœ¨æª¢æŸ¥é›²ç«¯é€£ç·š...</p>
    </div>
    <div class="flex gap-4">
      <button onclick="resetForm()" class="text-sm text-stone-400 hover:text-stone-600 font-medium">æ¸…ç©ºè¼¸å…¥æ¡†</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <!-- å·¦å´ï¼šå¯Œæ–‡æœ¬ç·¨è¼¯èˆ‡ç™¼ä½ˆå€ (ä½” 7 æ ¼) -->
    <div class="lg:col-span-7">
      <section class="card">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-stone-800">âœï¸ <span id="form-title">æ’°å¯«éƒ¨è½æ ¼æ–‡ç« </span></h2>
        
        <div class="space-y-6">
          <input type="hidden" id="edit-id">
          <input type="hidden" id="edit-type">

          <div>
            <label class="block text-sm font-bold mb-1 text-stone-500">æ¨™é¡Œæˆ–å·¥å…·åç¨±</label>
            <input type="text" id="main-title" placeholder="ä¾‹å¦‚ï¼š113å¹´ç‡Ÿæ¥­ç¨…ç”³å ±æ‡¶äººåŒ…" class="input-field text-lg font-bold">
          </div>

          <div id="link-field-container">
            <label class="block text-sm font-bold mb-1 text-stone-500">å¤–éƒ¨é€£çµ (è‹¥ç‚ºå·¥å…·ï¼Œè«‹å¡«å¯«ç¶²å€)</label>
            <input type="text" id="sub-link" placeholder="https://..." class="input-field">
            <p class="text-[10px] text-stone-400 mt-1">* å¡«å¯«é€£çµå°‡è‡ªå‹•æ­¸é¡ç‚ºã€Œç¨…å‹™å·¥å…·ã€ä¸¦ç•¥éæ–‡ç« è©³ç´°å…§å®¹</p>
          </div>

          <div>
            <label class="block text-sm font-bold mb-1 text-stone-500">æ–‡ç« å…§å®¹æ’ç‰ˆ</label>
            <!-- Quill å®¹å™¨ -->
            <div id="editor-container"></div>
          </div>

          <button onclick="saveData()" id="save-btn" class="btn-primary w-full shadow-lg shadow-stone-200 py-4 text-lg">
            ç¢ºèªå„²å­˜ä¸¦ç™¼ä½ˆ
          </button>
        </div>
      </section>
    </div>

    <!-- å³å´ï¼šè³‡æ–™æ¸…å–®ç®¡ç† (ä½” 5 æ ¼) -->
    <div class="lg:col-span-5 space-y-6">
      
      <!-- æ–‡ç« ç®¡ç† -->
      <section class="card">
        <h2 class="text-lg font-bold mb-4 border-b pb-2 flex items-center gap-2">ğŸ“˜ ç¨…å‹™æ–°çŸ¥ <span class="text-xs bg-stone-100 px-2 py-1 rounded text-stone-400">ç¸½è¦½</span></h2>
        <div id="manage-articles-list" class="divide-y divide-stone-100 max-h-[300px] overflow-y-auto pr-2">
          <p class="py-4 text-stone-300 text-center italic">è¼‰å…¥æ¸…å–®ä¸­...</p>
        </div>
      </section>

      <!-- å·¥å…·ç®¡ç† -->
      <section class="card">
        <h2 class="text-lg font-bold mb-4 border-b pb-2 flex items-center gap-2">ğŸ§® ç¨…å‹™å·¥å…· <span class="text-xs bg-stone-100 px-2 py-1 rounded text-stone-400">ç¸½è¦½</span></h2>
        <div id="manage-tools-list" class="divide-y divide-stone-100 max-h-[300px] overflow-y-auto pr-2">
          <p class="py-4 text-stone-300 text-center italic">è¼‰å…¥æ¸…å–®ä¸­...</p>
        </div>
      </section>

    </div>

  </main>

  <script>
    // ç·¨è¼¯åŠŸèƒ½ï¼šå°‡è³‡æ–™å¡«å›å¯Œæ–‡æœ¬ç·¨è¼¯å™¨
    function editItem(type, id, encodedData) {
      const data = JSON.parse(decodeURIComponent(atob(encodedData)));
      
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-type').value = type;
      
      document.getElementById('main-title').value = data.title || data.name;
      document.getElementById('sub-link').value = data.link || "";
      
      // å°‡å…§å®¹è¼‰å…¥ Quill
      const content = data.content || data.description || "";
      window.quill.root.innerHTML = content;
      
      document.getElementById('form-title').innerText = "æ­£åœ¨ä¿®æ”¹å…§å®¹";
      document.getElementById('save-btn').innerText = "æ›´æ–°é›²ç«¯è³‡æ–™";
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // åˆªé™¤åŠŸèƒ½
    async function deleteItem(type, id) {
      if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ\nåˆªé™¤å¾Œå®¢æˆ¶ç«¯ç¶²é ä¹ŸæœƒåŒæ­¥ç§»é™¤ã€‚")) return;
      
      try {
        await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', type, id));
        alert("å·²æˆåŠŸç§»é™¤ï¼");
      } catch (e) {
        alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
      }
    }

    // å„²å­˜é‚è¼¯
    async function saveData() {
      const id = document.getElementById('edit-id').value;
      const title = document.getElementById('main-title').value;
      const link = document.getElementById('sub-link').value;
      
      // ç²å– Quill ä¸­çš„ HTML å…§å®¹
      const content = window.quill.root.innerHTML;

      // åˆ¤æ–·åˆ†é¡
      let type = document.getElementById('edit-type').value;
      if (!type) {
        type = link.trim() !== "" ? "tools" : "articles";
      }

      if(!title || (type === 'articles' && window.quill.getText().trim() === "")) {
        return alert("æ¨™é¡Œèˆ‡æ–‡ç« å…§å®¹æ˜¯å¿…å¡«çš„å–”ï¼");
      }

      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.innerText = "æ­£åœ¨åŒæ­¥é›²ç«¯æ’ç‰ˆ...";

      try {
        if(id) {
          // æ›´æ–°æ¨¡å¼
          const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', type, id);
          const updateData = type === 'articles' ? 
            { title, content } : 
            { name: title, description: content, link };
          
          await window.updateDoc(docRef, updateData);
          alert("âœ… æ’ç‰ˆå·²æ›´æ–°ï¼");
        } else {
          // æ–°å¢æ¨¡å¼
          const colRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', type);
          const newData = type === 'tools' ? 
            { name: title, description: content, link, createdAt: window.serverTimestamp() } : 
            { title, content, createdAt: window.serverTimestamp() };
          
          await window.addDoc(colRef, newData);
          alert("ğŸ‰ æ–‡ç« å·²ç²¾ç¾ç™¼ä½ˆï¼");
        }
        resetForm();
      } catch (e) {
        console.error(e);
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚");
      } finally {
        btn.disabled = false;
      }
    }

    // é‡è¨­è¡¨å–®
    function resetForm() {
      document.getElementById('edit-id').value = "";
      document.getElementById('edit-type').value = "";
      document.getElementById('main-title').value = "";
      document.getElementById('sub-link').value = "";
      window.quill.setContents([]); // æ¸…ç©ºç·¨è¼¯å™¨
      document.getElementById('form-title').innerText = "æ’°å¯«éƒ¨è½æ ¼æ–‡ç« ";
      document.getElementById('save-btn').innerText = "ç¢ºèªå„²å­˜ä¸¦ç™¼ä½ˆ";
    }
  </script>
</body>
</html>
