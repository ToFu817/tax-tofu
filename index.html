<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¨…å‹™å°è±†è…ï½œAI æ™ºæ…§ç¨…å‹™åŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --yellow: #FFF2CC;
      --light-yellow: #FFF8E6;
      --white: #FFFFFF;
      --text: #54473F;
      --accent: #8D7B68;
    }
    body {
      margin: 0;
      font-family: "Noto Sans TC", sans-serif;
      color: var(--text);
      background: var(--light-yellow);
      overflow-x: hidden;
    }
    
    /* ===== å•Ÿå‹•å‹•ç•« ===== */
    #splash {
      position: fixed; inset: 0; background: var(--yellow);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
      transition: opacity 0.8s ease-out;
    }
    .tofu-box {
      width: 120px; height: 120px; background: white; border-radius: 24px;
      position: relative;
      box-shadow: 0 10px 0 rgba(0,0,0,0.05);
      animation: bounce-tofu 0.8s infinite alternate cubic-bezier(0.45, 0, 0.55, 1);
      display: flex; align-items: center; justify-content: center;
    }
    .tofu-eyes { display: flex; gap: 20px; }
    .eye { width: 12px; height: 12px; background: #54473F; border-radius: 50%; animation: blink 3s infinite; }
    @keyframes bounce-tofu { from { transform: translateY(0); } to { transform: translateY(-40px); } }
    @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }

    .card {
      background: var(--white);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      transition: 0.3s;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    
    .sub-page {
      position: fixed; top: 0; left: 100%; width: 100%; height: 100%;
      background: var(--light-yellow); z-index: 1000;
      transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }
    .sub-page.active { left: 0; }

    /* æ–‡ç« ç´°ç¯€é  */
    #article-detail-page {
      z-index: 1100;
    }

    /* åˆ†é¡æ¨™ç±¤æ¨£å¼ */
    .cat-btn {
      padding: 8px 20px;
      border-radius: 99px;
      background: white;
      font-weight: bold;
      font-size: 0.9rem;
      transition: 0.3s;
      border: 2px solid transparent;
    }
    .cat-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(141, 123, 104, 0.3);
    }

    /* AI èŠå¤©è¦–çª— */
    #ai-chat-bubble {
      position: fixed; bottom: 30px; right: 30px; z-index: 1500;
      width: 60px; height: 60px; background: var(--accent);
      border-radius: 50%; cursor: pointer; display: flex;
      align-items: center; justify-content: center; color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: 0.3s;
    }
    #ai-window {
      position: fixed; bottom: 100px; right: 30px; z-index: 1500;
      width: 350px; height: 500px; background: white; border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column;
      overflow: hidden;
    }

    .article-body-content img { max-width: 100%; border-radius: 12px; margin: 20px 0; }
    .ai-summary-box {
      background: #fdf2f8; border-left: 4px solid #db2777;
      padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcYPHZJcSTBRbhKy018keO7FiPyzb4c84",
      authDomain: "tax-tofu.firebaseapp.com",
      projectId: "tax-tofu",
      storageBucket: "tax-tofu.firebasestorage.app",
      messagingSenderId: "1031361168988",
      appId: "1:1031361168988:web:ce06888cfd84de93958899",
      measurementId: "G-TQ29X7NGZY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = "tax-tofu";
    const geminiApiKey = "";

    let currentCategoryId = "all";
    let allArticles = [];
    let categories = [];

    // --- Gemini API ---
    async function callGemini(prompt, systemPrompt) {
      try {
        let retries = 0;
        const delays = [1000, 2000, 4000, 8000, 16000];
        while (retries < 5) {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] }
            })
          });
          if (response.ok) {
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
          }
          await new Promise(res => setTimeout(res, delays[retries]));
          retries++;
        }
        return "æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } catch (error) { return "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"; }
    }

    // --- è³‡æ–™ç›£è½ ---
    
    // ç›£è½åˆ†é¡ (è®€å– artifacts/tax-tofu/public/data/categories)
    const catsCol = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
    onSnapshot(query(catsCol, orderBy('weight', 'desc')), (snapshot) => {
      categories = [];
      snapshot.forEach(doc => categories.push({ id: doc.id, ...doc.data() }));
      renderCategoryFilters();
    });

    // ç›£è½æ–‡ç« 
    const articlesCol = collection(db, 'artifacts', appId, 'public', 'data', 'articles');
    onSnapshot(query(articlesCol, orderBy('createdAt', 'desc')), (snapshot) => {
      allArticles = [];
      snapshot.forEach(doc => allArticles.push({ id: doc.id, ...doc.data() }));
      renderArticles();
    });

    // ç›£è½å·¥å…·
    const toolsCol = collection(db, 'artifacts', appId, 'public', 'data', 'tools');
    onSnapshot(query(toolsCol, orderBy('createdAt', 'desc')), (snapshot) => {
      const container = document.getElementById('tools-list');
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        container.innerHTML += `
          <a href="${data.link}" target="_blank" class="card block border-l-4 border-amber-200">
            <h3 class="font-bold text-lg mb-1 text-stone-700">ğŸ§® ${data.name}</h3>
            <p class="text-sm text-stone-500">${data.description || 'é»æ“Šé€²å…¥å·¥å…·é é¢'}</p>
          </a>
        `;
      });
    });

    // --- æ¸²æŸ“åŠŸèƒ½ ---

    function renderCategoryFilters() {
      const container = document.getElementById('category-filters');
      container.innerHTML = `<button onclick="filterCategory('all')" class="cat-btn ${currentCategoryId === 'all' ? 'active' : ''}">å…¨éƒ¨</button>`;
      categories.forEach(cat => {
        container.innerHTML += `<button onclick="filterCategory('${cat.id}')" class="cat-btn ${currentCategoryId === cat.id ? 'active' : ''}">${cat.name}</button>`;
      });
    }

    window.filterCategory = (id) => {
      currentCategoryId = id;
      renderCategoryFilters();
      renderArticles();
    };

    function renderArticles() {
      const container = document.getElementById('articles-list');
      container.innerHTML = "";
      
      const filtered = currentCategoryId === "all" 
        ? allArticles 
        : allArticles.filter(a => a.categoryId === currentCategoryId);

      if(filtered.length === 0) {
        container.innerHTML = `<div class="text-center py-20 text-stone-400">ç›®å‰æ­¤åˆ†é¡å°šç„¡å…§å®¹</div>`;
        return;
      }

      filtered.forEach(data => {
        container.innerHTML += `
          <div class="card">
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs font-bold text-stone-400 px-2 py-1 bg-stone-100 rounded">${getCategoryName(data.categoryId)}</span>
              <button onclick="summarizeArticle('${data.id}')" class="text-xs bg-pink-50 text-pink-600 px-3 py-1 rounded-full border border-pink-100 hover:bg-pink-100 transition">
                âœ¨ ç²¾ç°¡æ‘˜è¦
              </button>
            </div>
            <h3 class="font-bold text-xl text-stone-700 mb-3 cursor-pointer hover:text-stone-900" onclick="openArticleDetail('${data.id}')">ğŸ“˜ ${data.title}</h3>
            <div id="summary-${data.id}" class="ai-summary-box text-sm leading-relaxed mb-4 italic"></div>
            <p class="text-sm text-stone-400 line-clamp-2 mb-4">${stripHtml(data.content)}</p>
            <button onclick="openArticleDetail('${data.id}')" class="text-sm font-bold underline text-stone-600">é–±è®€å…¨æ–‡ â†’</button>
          </div>
        `;
      });
    }

    function getCategoryName(id) {
      const cat = categories.find(c => c.id === id);
      return cat ? cat.name : "æœªåˆ†é¡";
    }

    function stripHtml(html) {
      let tmp = document.createElement("DIV");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    // --- æ–‡ç« è©³æƒ…é æ§åˆ¶ ---
    window.openArticleDetail = (id) => {
      const article = allArticles.find(a => a.id === id);
      if(!article) return;
      
      document.getElementById('detail-category').innerText = getCategoryName(article.categoryId);
      document.getElementById('detail-title').innerText = article.title;
      document.getElementById('detail-content').innerHTML = article.content;
      
      window.showPage('article-detail-page');
    };

    window.summarizeArticle = async (id) => {
      const summaryDiv = document.getElementById(`summary-${id}`);
      const article = allArticles.find(a => a.id === id);
      if(!article) return;
      
      summaryDiv.style.display = "block";
      summaryDiv.innerHTML = "âœ¨ å°è±†è…æ‘˜è¦ä¸­...";
      
      const prompt = `è«‹ç”¨ 3 å€‹é‡é»æ‘˜è¦é€™ç¯‡ç¨…å‹™æ–‡ç« ï¼Œå­—æ•¸è¦å°‘ï¼Œåªè¬›æ ¸å¿ƒé‡é»ï¼š\n\n${stripHtml(article.content)}`;
      const systemPrompt = "ä½ æ˜¯ä¸€ä½æ¥µè‡´ç°¡ç´„çš„ç¨…å‹™å°ˆå®¶ã€‚å›ç­”å¿…é ˆç²¾ç°¡ã€æº–ç¢ºï¼Œç›´æ¥æ¢åˆ—é‡é»ï¼Œä¸èªªå»¢è©±ï¼Œä¸æ‰“æ‹›å‘¼ã€‚";
      
      const summary = await callGemini(prompt, systemPrompt);
      summaryDiv.innerHTML = `<strong>âœ¨ é‡é»æ‘˜è¦ï¼š</strong><br>${summary.replace(/\n/g, '<br>')}`;
    };

    // --- èŠå¤©åŠŸèƒ½ ---
    window.toggleChat = () => {
      const win = document.getElementById('ai-window');
      win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
    };

    window.sendChat = async () => {
      const input = document.getElementById('chat-input');
      const box = document.getElementById('chat-box');
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";
      box.innerHTML += `<div class="mb-2 text-right"><span class="bg-stone-100 px-3 py-2 rounded-lg text-sm inline-block">${msg}</span></div>`;
      box.scrollTop = box.scrollHeight;
      const loadingId = "loading-" + Date.now();
      box.innerHTML += `<div id="${loadingId}" class="mb-2"><span class="bg-amber-50 px-3 py-2 rounded-lg text-sm inline-block italic text-stone-400">ç ”è®€ä¸­...</span></div>`;
      const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£ç¨…å‹™å°ˆå®¶ã€‚å›ç­”åŸå‰‡ï¼š1. å…§å®¹ç²¾ç°¡ 2. ç›´æ¥å›ç­” 3. ä¸è¦å»¢è©± 4. æ¢åˆ—å„ªæ–¼é•·å¥ã€‚";
      const response = await callGemini(msg, systemPrompt);
      document.getElementById(loadingId).innerHTML = `<span class="bg-amber-100 px-3 py-2 rounded-lg text-sm inline-block">${response.replace(/\n/g, '<br>')}</span>`;
      box.scrollTop = box.scrollHeight;
    };

    // --- é é¢è·³è½‰ ---
    window.showPage = (id) => {
      document.getElementById(id).classList.add('active');
      document.body.style.overflow = 'hidden';
    };
    window.closePage = (id) => {
      document.getElementById(id).classList.remove('active');
      if (!document.querySelector('.sub-page.active')) {
        document.body.style.overflow = 'auto';
      }
    };

    window.onload = () => {
      setTimeout(() => {
        const splash = document.getElementById('splash');
        if(splash) {
          splash.style.opacity = '0';
          setTimeout(() => splash.style.display = 'none', 800);
        }
      }, 1500);
    };
  </script>
</head>
<body>

  <div id="splash">
    <div class="tofu-box">
      <div class="tofu-eyes"><div class="eye"></div><div class="eye"></div></div>
    </div>
  </div>

  <!-- AI èŠå¤© -->
  <div id="ai-chat-bubble" onclick="toggleChat()">âœ¨</div>
  <div id="ai-window">
    <div class="bg-stone-800 p-4 text-white font-bold flex justify-between items-center">
      <span>âœ¨ æ™ºæ…§å°è±†è…è«®è©¢</span>
      <button onclick="toggleChat()">âœ•</button>
    </div>
    <div id="chat-box" class="flex-1 p-4 overflow-y-auto bg-stone-50 text-sm">
      <div class="mb-2"><span class="bg-amber-100 px-3 py-2 rounded-lg text-sm inline-block">ä½ å¥½ï¼Œæœ‰ä»€éº¼ç¨…å‹™å•é¡Œï¼Ÿ</span></div>
    </div>
    <div class="p-3 border-t flex gap-2">
      <input id="chat-input" type="text" placeholder="è¼¸å…¥æ‚¨çš„ç¨…å‹™å•é¡Œ..." class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200" onkeypress="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()" class="bg-stone-800 text-white px-4 py-2 rounded-lg text-sm font-bold">ç™¼é€</button>
    </div>
  </div>

  <header class="py-20 px-4 text-center bg-white border-b border-amber-50 shadow-sm">
    <h1 class="text-5xl font-black text-stone-800 tracking-tighter">ç¨…å‹™å°è±†è…</h1>
    <p class="text-stone-400 mt-6 text-lg font-medium">è‡´åŠ›æ–¼è®“ç¨…å‹™ï¼Œåƒæ˜¯åˆ‡ä¸€å¡Šè±†è…ä¸€æ¨£ç°¡å–®çš„äº‹æƒ…</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-16">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div class="card text-center py-12" onclick="showPage('page-articles')">
        <div class="text-6xl mb-6">ğŸ“˜</div>
        <h2 class="text-2xl font-bold">ç¨…å‹™æ–°çŸ¥</h2>
        <p class="text-sm text-stone-400 mt-2">âœ¨ åˆ†é¡ç€è¦½èˆ‡ AI æ‘˜è¦</p>
      </div>
      <div class="card text-center py-12" onclick="showPage('page-tools')">
        <div class="text-6xl mb-6">ğŸ§®</div>
        <h2 class="text-2xl font-bold">ç¨…å‹™å°å·¥å…·</h2>
        <p class="text-sm text-stone-400 mt-2">ç®—è¡¨èˆ‡å¯¦ç”¨é€£çµ</p>
      </div>
      <a href="https://lin.ee/98FMxAk" target="_blank" class="card text-center py-12 block">
        <div class="text-6xl mb-6">ğŸ’¬</div>
        <h2 class="text-2xl font-bold">é ç´„è«®è©¢</h2>
        <p class="text-sm text-stone-400 mt-2">ä¸€å°ä¸€è±†è…æœå‹™</p>
      </a>
    </div>
  </main>

  <!-- ç¨…å‹™æ–°çŸ¥åˆ—è¡¨é  -->
  <div id="page-articles" class="sub-page p-6 md:p-12">
    <div class="max-w-4xl mx-auto">
      <button onclick="closePage('page-articles')" class="mb-8 text-stone-400 hover:text-stone-800 flex items-center gap-2 font-bold">â† è¿”å›é¦–é </button>
      <h2 class="text-3xl font-black mb-6 text-stone-800">ğŸ“˜ ç¨…å‹™æœ€æ–°å‹•æ…‹</h2>
      
      <!-- å‹•æ…‹åˆ†é¡ç¯©é¸å€ -->
      <div id="category-filters" class="flex flex-wrap gap-3 mb-10 pb-4 border-b border-stone-200">
        <!-- JS æœƒåœ¨æ­¤å¡«å…¥åˆ†é¡ -->
      </div>

      <div id="articles-list" class="space-y-6"></div>
    </div>
  </div>

  <!-- æ–‡ç« è©³æƒ…å­é é¢ -->
  <div id="article-detail-page" class="sub-page p-6 md:p-12">
    <div class="max-w-3xl mx-auto">
      <button onclick="closePage('article-detail-page')" class="mb-10 text-stone-400 hover:text-stone-800 flex items-center gap-2 font-bold">â† è¿”å›åˆ—è¡¨</button>
      <div class="mb-4 text-sm font-bold text-accent uppercase tracking-widest" id="detail-category">åˆ†é¡åç¨±</div>
      <h1 class="text-4xl font-black mb-10 text-stone-800 leading-tight" id="detail-title">æ–‡ç« æ¨™é¡Œ</h1>
      <div class="article-body-content text-lg text-stone-600 leading-loose" id="detail-content">
        <!-- æ–‡ç« å…§å®¹ -->
      </div>
      <div class="h-24"></div>
    </div>
  </div>

  <div id="page-tools" class="sub-page p-6 md:p-12">
    <div class="max-w-3xl mx-auto">
      <button onclick="closePage('page-tools')" class="mb-8 text-stone-400 hover:text-stone-800 flex items-center gap-2 font-bold">â† è¿”å›é¦–é </button>
      <h2 class="text-3xl font-black mb-10 text-stone-800">ğŸ§® å¯¦ç”¨å°å·¥å…·</h2>
      <div id="tools-list" class="grid grid-cols-1 gap-4"></div>
    </div>
  </div>

  <footer class="bg-stone-800 py-16 text-center text-stone-100 text-sm mt-12">
    <div class="font-bold text-lg mb-2">ç¨…å‹™å°è±†è… - ä½ çš„å‰µæ¥­å¥½å¤¥ä¼´</div>
    <div class="text-stone-400 mb-4">å®˜æ–¹lineå¸³è™Ÿï¼š@196amypy</div>
    <div class="w-12 h-1 bg-amber-200 mx-auto mt-6 opacity-30"></div>
  </footer>

</body>
</html>
